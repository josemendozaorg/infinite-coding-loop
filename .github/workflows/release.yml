name: Publish GitHub Release

on:
  push:
    tags:
      - 'v*' # Trigger automatically when a version tag (e.g., v0.1.2) is pushed

jobs:
  release:
    name: Create Release
    runs-on: ubuntu-latest
    permissions:
      contents: write # Needed to create GitHub Releases

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Extract latest release notes from CHANGELOG.md
        id: extract_notes
        run: |
          node -e "
          const fs = require('fs');
          const content = fs.readFileSync('CHANGELOG.md', 'utf8');
          const lines = content.split('
');
          let capturing = false;
          let notes = [];
          for (const line of lines) {
            // Match standard-version's header format, e.g., ### [1.0.0] or ### 1.0.0
            if (line.match(/^#+ \[?\d+\.\d+\.\d+/)) {
              if (capturing) break; // Reached the previous version's header
              capturing = true;
              continue; // Skip the version header line itself
            }
            if (capturing) {
              notes.push(line);
            }
          }
          // Trim empty lines from the start and end
          fs.writeFileSync('RELEASE_NOTES.md', notes.join('
').trim());
          "

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          body_path: RELEASE_NOTES.md
          generate_release_notes: false
